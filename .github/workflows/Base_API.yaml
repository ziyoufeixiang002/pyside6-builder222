# .github/workflows/build-docs.yml
name: Build PySide6 Docs (Base + API)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-2022, macos-13]
        python-version: ['3.10']

    steps:
      - name: Checkout pyside-setup
        uses: actions/checkout@v4
        with:
          repository: pyside/pyside-setup
          path: pyside-setup

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt1-dev libgl1 libxcb-xinerama0 \
            libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 \
            libxcb-shape0 libxcb-xfixes0 libxcb-xkb1 libxkbcommon-x11-0 graphviz
          # Install qdoc via Qt6 dev tools (fallback)
          sudo apt-get install -y qt6-base-dev-tools  # provides qdoc

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libxml2 libxslt graphviz
          # qdoc will be taken from PySide6 wheel (macOS wheels include it)

      - name: Install PySide6 (to get qdoc & headers)
        run: |
          pip install --upgrade pip
          pip install PySide6==6.7.0  # use fixed version for stability

      - name: Locate qdoc and qtbase include path
        id: find-tools
        shell: bash
        run: |
          # Try to find qdoc in PySide6 install
          QDOC_PATH=$(python -c "
import PySide6
import os, glob
site_pkg = os.path.dirname(PySide6.__file__)
candidates = glob.glob(os.path.join(site_pkg, 'Qt', 'bin', 'qdoc*')) + \
             glob.glob(os.path.join(site_pkg, '..', '..', 'Qt6', 'bin', 'qdoc*')) + \
             glob.glob('/usr/lib/qt6/bin/qdoc') + \
             glob.glob('/opt/homebrew/opt/qt@6/bin/qdoc') + \
             glob.glob('C:/Qt/*/msvc*/*/bin/qdoc.exe')
print(candidates[0] if candidates else '')
          ")
          if [[ -z "$QDOC_PATH" ]]; then
            echo "qdoc not found! Falling back to system qdoc (if exists)"
            QDOC_PATH=$(which qdoc || echo "")
          fi
          echo "qdoc_path=$QDOC_PATH" >> $GITHUB_ENV

          # Locate qtbase headers: from PySide6/Qt/include
          QT_INCLUDE=$(python -c "
import PySide6, os
site_pkg = os.path.dirname(PySide6.__file__)
inc = os.path.join(site_pkg, 'Qt', 'include')
print(inc if os.path.isdir(inc) else '')
          ")
          echo "qt_src_dir=$QT_INCLUDE" >> $GITHUB_ENV

          echo "Found qdoc: $QDOC_PATH"
          echo "Qt include dir: $QT_INCLUDE"

      - name: Verify qdoc and include dir
        run: |
          echo "qdoc path: ${{ env.qdoc_path }}"
          echo "qt_src_dir: ${{ env.qt_src_dir }}"
          if [[ -z "${{ env.qdoc_path }}" ]] || [[ ! -x "${{ env.qdoc_path }}" ]]; then
            echo "❌ qdoc not found or not executable"
            exit 1
          fi
          if [[ ! -d "${{ env.qt_src_dir }}/QtCore" ]]; then
            echo "❌ qtbase headers (QtCore) not found in ${{ env.qt_src_dir }}"
            exit 1
          fi

      - name: Install doc build requirements
        working-directory: pyside-setup
        run: |
          pip install -r requirements-doc.txt

      - name: Build PySide6 (with --build-docs)
        working-directory: pyside-setup
        run: |
          python setup.py build \
            --build-docs \
            --doc-build-online \
            --qt-src-dir "${{ env.qt_src_dir }}" \
            --qdoc "${{ env.qdoc_path }}"

      - name: Build API docs (ninja apidoc)
        working-directory: pyside-setup/build/$(ls build | head -n1)/build/pyside6
        run: |
          # Ensure ninja is available
          pip install ninja
          ninja apidoc -j 2

      - name: Upload HTML docs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyside6-docs-${{ matrix.os }}
          path: pyside-setup/build/*/build/pyside6/doc/html/

      - name: Upload QCH files (optional)
        if: runner.os != 'Windows'  # Windows paths messy; skip for simplicity
        uses: actions/upload-artifact@v4
        with:
          name: pyside6-qch-${{ matrix.os }}
          path: |
            pyside-setup/build/*/build/pyside6/doc/PySide6.qch
            pyside-setup/build/*/build/shiboken6/doc/Shiboken6.qch
