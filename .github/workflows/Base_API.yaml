name: Build PySide6 Documentation (Base + API) - List Qt Modules First

on:
  push:
    branches: [ main ] # 或者您希望触发构建的分支
  pull_request:
    branches: [ main ] # 或者您希望触发构建的分支
  workflow_dispatch: # 允许手动触发

jobs:
  build-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout PySide6 Setup Repository
      uses: actions/checkout@v4
      with:
        repository: pyside/pyside-setup
        path: pyside-setup

    # --- 安装系统依赖 ---
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git libclang-dev libxml2-dev libxslt1-dev python3-dev graphviz libgl1-mesa-dev libxcb-cursor-dev libxcb-xinerama0-dev libxcb-randr0-dev libxcb-xtest0-dev libxcb-shape0-dev libxcb-xfixes0-dev

    # --- 设置 Python 环境 ---
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # --- 安装 aqtinstall ---
    - name: Install aqtinstall
      run: |
        python -m pip install aqtinstall

    # --- 列出可用的 Qt 版本和架构 ---
    - name: List Available Qt Versions and Architectures
      run: |
        echo "Listing available architectures for Qt 6.8.0 on linux desktop..."
        aqt list-qt linux desktop --arch 6.8.0 || echo "Command failed or no arch found for 6.8.0"
        echo "Listing available modules for Qt 6.8.0 gcc_64..."
        aqt list-qt linux desktop --modules 6.8.0 gcc_64 || echo "Command failed or no modules found for 6.8.0 gcc_64"
        echo "Listing available versions for linux desktop..."
        aqt list-qt linux desktop --filter-regex "^6\.[0-9]+\.[0-9]+$" | sort -V | tail -10 || echo "Command failed or no 6.x versions found"

    # --- 安装 Qt (尝试安装默认的，它通常包含核心组件) ---
    - name: Install Qt SDK (Default)
      env:
        QT_VERSION: "6.8.0" # 请根据 pyside-setup 版本调整
        QT_HOST: "linux"
        QT_TARGET: "desktop"
        QT_ARCH: "gcc_64"
      run: |
        echo "Attempting to install Qt $QT_VERSION $QT_ARCH for $QT_TARGET on $QT_HOST (default install)..."
        # 不指定 -m qtbase，而是进行默认安装，这通常会安装核心库
        aqt install-qt $QT_HOST $QT_TARGET $QT_VERSION $QT_ARCH --outputdir ./Qt
        # 如果默认安装失败或不包含必要组件，再尝试明确安装核心模块
        # aqtinstall 可能会根据版本自动包含必要的核心组件
        # 将 Qt 工具添加到 PATH
        echo "${{ github.workspace }}/Qt/$QT_VERSION/$QT_ARCH/bin" >> $GITHUB_PATH
        # 设置环境变量
        echo "QT_DIR=${{ github.workspace }}/Qt/$QT_VERSION/$QT_ARCH" >> $GITHUB_ENV
        echo "QT_VERSION=$QT_VERSION" >> $GITHUB_ENV
        echo "QT_ARCH=$QT_ARCH" >> $GITHUB_ENV

    # --- 验证 Qt 安装 ---
    - name: Verify Qt Installation
      run: |
        echo "QT_DIR is: $QT_DIR"
        echo "Looking for qtpaths6..."
        which qtpaths6
        if [ $? -ne 0 ]; then
            echo "ERROR: qtpaths6 not found in PATH."
            ls -la $QT_DIR/bin/
            exit 1
        fi
        echo "Looking for CMake config files..."
        find $QT_DIR -name "Qt6CoreConfig.cmake" -type f | head -n 5
        if [ $? -ne 0 ]; then
            echo "ERROR: Qt6CoreConfig.cmake or similar not found."
            find $QT_DIR/lib/cmake -name "Qt6*" -type f | head -n 10
            exit 1
        fi
        echo "Qt installation seems OK."

    # --- 升级并固定核心构建工具版本 ---
    - name: Upgrade and Pin Core Build Tools
      working-directory: ./pyside-setup
      run: |
        python -m pip install --upgrade pip setuptools wheel==0.42.0

    # --- 安装 Python 依赖 ---
    - name: Install Python Documentation Requirements
      working-directory: ./pyside-setup
      run: |
        python -m pip install --upgrade setuptools wheel==0.42.0
        if [ -f requirements-doc.txt ]; then
            echo "Installing requirements from requirements-doc.txt..."
            python -m pip install -r requirements-doc.txt
        else
            echo "requirements-doc.txt not found. Installing minimal set for documentation."
            python -m pip install sphinx sphinx-rtd-theme
        fi

    # --- 获取 Qt 源码 (用于文档构建) ---
    - name: Get Qt Source Code (for docs)
      run: |
        git clone --filter=blob:none --sparse https://github.com/qt/qt5.git qt5_src
        cd qt5_src
        # 检出与安装的 Qt 版本匹配的源码
        git fetch --all --tags
        # 列出最新的几个 6.x 标签供参考（可选）
        echo "Fetching available 6.x tags..."
        git tag -l | grep -E "^v?[0-9]+\.6\.[0-9]+$" | sort -V | tail -5 || echo "No 6.x tags found or command failed"
        QT_TAG="v6.8.0" # 必须与上面安装的版本一致
        echo "Checking out Qt source tag: $QT_TAG"
        git checkout tags/$QT_TAG -b qt-$QT_TAG
        git submodule update --init --depth 1 qtbase

    # --- 构建 Shiboken 和 PySide6 (包含文档) - 明确指定 Qt 路径 ---
    - name: Build Shiboken and PySide6 (with Docs) - Explicit Qt Path
      working-directory: ./pyside-setup
      env:
        # 确保环境变量被传递
        QT_DIR: ${{ env.QT_DIR }}
        QT_VERSION: ${{ env.QT_VERSION }}
        QT_ARCH: ${{ env.QT_ARCH }}
      run: |
        echo "QT_DIR: $QT_DIR"
        echo "QT_VERSION: $QT_VERSION"
        echo "QT_ARCH: $QT_ARCH"
        # 确认 Qt 工具在 PATH 中
        QTPATHS_PATH=$(which qtpaths6)
        echo "qtpaths6 found at: $QTPATHS_PATH"
        # 检查 qtpaths6 输出
        echo "qtpaths6 --query QT_VERSION output:"
        $QTPATHS_PATH --query QT_VERSION
        # 执行构建命令，明确指定 qtpaths6 路径和 Qt 源码路径
        python setup.py build \
          --build-type=all \
          --parallel 2 \
          --build-docs \
          --qtpaths="$QTPATHS_PATH" \
          --qt-src-dir=../qt5_src


    # --- 尝试运行 ninja apidoc (如果 setup.py build 未完成) ---
    - name: Run Ninja API Doc Build (if needed)
      working-directory: ./pyside-setup
      run: |
        PYSIDE_BUILD_DIR=$(find build -maxdepth 3 -name "pyside6" -type d -path "*/build/*" | head -n 1)
        SHIBOKEN_BUILD_DIR=$(find build -maxdepth 3 -name "shiboken6" -type d -path "*/build/*" | head -n 1)

        echo "PySide6 Build Dir Candidate: $PYSIDE_BUILD_DIR"
        echo "Shiboken6 Build Dir Candidate: $SHIBOKEN_BUILD_DIR"

        if [ -n "$PYSIDE_BUILD_DIR" ] && [ -d "$PYSIDE_BUILD_DIR" ]; then
            echo "Found PySide6 build directory: $PYSIDE_BUILD_DIR"
            cd "$PYSIDE_BUILD_DIR"
            if [ -f "build.ninja" ]; then
                echo "build.ninja found, running: ninja apidoc -j 2"
                ninja apidoc -j 2
            else
                echo "build.ninja NOT found in $PYSIDE_BUILD_DIR."
                ls -la
            fi
        else
            echo "PySide6 build directory NOT FOUND."
            find build -type d -name "*" | head -20
        fi

        if [ -n "$SHIBOKEN_BUILD_DIR" ] && [ -d "$SHIBOKEN_BUILD_DIR" ]; then
            echo "Found Shiboken6 build directory: $SHIBOKEN_BUILD_DIR"
            cd "$SHIBOKEN_BUILD_DIR"
            if [ -f "build.ninja" ]; then
                 echo "Shiboken6 build.ninja exists."
            fi
        fi

    # --- 上传文档工件 ---
    - name: Upload Documentation Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PySide6-Docs-Base-API-ListModulesFirst
        path: |
          pyside-setup/build/*/build/*/doc/html
          pyside-setup/build/*/build/*/PySide.qch
          pyside-setup/build/*/build/*/Shiboken.qch
        if-no-files-found: warn
        retention-days: 30
