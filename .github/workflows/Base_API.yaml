name: Download PySide6 Official Documentation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'  # 每月第一天运行一次

env:
  PYSIDE_VERSION: '6.10.0'
  DOCS_BASE_URL: 'https://doc.qt.io/qtforpython-6'

jobs:
  download-documentation:
    name: Download PySide6 Docs
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository (for storing scripts)
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install web scraping tools
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 httpx playwright
        
    - name: Install browser for JavaScript rendering
      run: |
        python -m playwright install chromium
        python -m playwright install-deps
        
    - name: Create documentation download script
      run: |
        cat > download_docs.py << 'EOF'
        import os
        import requests
        from bs4 import BeautifulSoup
        import time
        import urllib.parse
        
        BASE_URL = os.environ.get('DOCS_BASE_URL', 'https://doc.qt.io/qtforpython-6')
        VERSION = os.environ.get('PYSIDE_VERSION', '6.10.0')
        OUTPUT_DIR = 'pyside6-docs'
        
        # 创建输出目录
        os.makedirs(OUTPUT_DIR, exist_ok=True)
        
        # 主要模块列表
        modules = [
            'PySide6', 'QtCore', 'QtGui', 'QtWidgets', 'QtNetwork', 
            'QtQml', 'QtQuick', 'QtQuickControls2', 'QtQuickWidgets',
            'QtWebEngine', 'QtWebEngineCore', 'QtWebEngineWidgets',
            'QtMultimedia', 'QtMultimediaWidgets', 'QtSql', 'QtTest',
            'QtXml', 'QtSvg', 'QtCharts', 'QtDataVisualization',
            'QtBluetooth', 'QtPositioning', 'QtWebChannel', 'QtWebSockets',
            'Qt3DCore', 'Qt3DRender', 'Qt3DInput', 'Qt3DLogic', 'Qt3DAnimation',
            'Qt3DExtras', 'Shiboken6'
        ]
        
        def download_page(url, filepath):
            """下载单个页面"""
            try:
                response = requests.get(url, timeout=30)
                if response.status_code == 200:
                    # 保存HTML文件
                    with open(filepath, 'w', encoding='utf-8') as f:
                        f.write(response.text)
                    print(f"✓ 下载成功: {filepath}")
                    return True
                else:
                    print(f"✗ 下载失败 {response.status_code}: {url}")
                    return False
            except Exception as e:
                print(f"✗ 错误下载 {url}: {e}")
                return False
        
        def get_module_urls(module):
            """获取模块的所有页面URL"""
            urls = []
            
            # 模块主页
            urls.append(f"{BASE_URL}/{module}/index.html")
            
            # 类列表页
            urls.append(f"{BASE_URL}/{module}/classes.html")
            
            # 根据模块类型添加特定页面
            if module == 'PySide6':
                urls.extend([
                    f"{BASE_URL}/PySide6/gettingstarted.html",
                    f"{BASE_URL}/PySide6/tutorials.html",
                    f"{BASE_URL}/PySide6/examples.html"
                ])
            
            return urls
        
        print("开始下载 PySide6 文档...")
        
        # 下载每个模块的文档
        for module in modules:
            print(f"\n=== 处理模块: {module} ===")
            module_dir = os.path.join(OUTPUT_DIR, module)
            os.makedirs(module_dir, exist_ok=True)
            
            urls = get_module_urls(module)
            for url in urls:
                filename = url.split('/')[-1]
                filepath = os.path.join(module_dir, filename)
                download_page(url, filepath)
                
                # 添加延迟避免被封锁
                time.sleep(1)
        
        # 创建索引页面
        index_content = """
        <!DOCTYPE html>
        <html>
        <head>
            <title>PySide6 $VERSION Documentation</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #333; }
                ul { list-style-type: none; padding: 0; }
                li { margin: 10px 0; }
                a { text-decoration: none; color: #0066cc; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <h1>PySide6 $VERSION Documentation</h1>
            <p>离线文档下载于: $(date)</p>
            <ul>
        """
        
        for module in modules:
            index_content += f'<li><a href="{module}/index.html">{module} Documentation</a></li>\n'
        
        index_content += """
            </ul>
            <p><em>Note: This is a mirrored version of the official online documentation.</em></p>
        </body>
        </html>
        """.replace('$VERSION', VERSION)
        
        with open(os.path.join(OUTPUT_DIR, 'index.html'), 'w', encoding='utf-8') as f:
            f.write(index_content)
        
        print(f"\n文档下载完成! 保存在目录: {OUTPUT_DIR}")
        EOF
        
    - name: Run documentation downloader
      run: |
        python download_docs.py
        
    - name: Use wget for comprehensive mirroring
      run: |
        # 使用wget进行更完整的镜像
        wget --mirror \
             --convert-links \
             --adjust-extension \
             --page-requisites \
             --no-parent \
             --no-host-directories \
             --restrict-file-names=windows \
             --reject-regex=".*\.svg,.*\.png,.*\.jpg,.*\.gif" \
             --wait=2 \
             --random-wait \
             --limit-rate=1M \
             -e robots=off \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
             --directory-prefix=pyside6-wget-docs \
             "$DOCS_BASE_URL" || echo "wget镜像完成或有部分错误"
        
    - name: Use httrack for advanced mirroring
      run: |
        # 安装httrack（更专业的网站镜像工具）
        sudo apt-get update
        sudo apt-get install -y httrack
        
        # 使用httrack镜像网站
        httrack "$DOCS_BASE_URL" \
          -O pyside6-httrack-docs \
          -%v \
          -r10 \
          -s0 \
          -#L100000 \
          -*.png *.jpg *.gif *.svg \
          +*.html *.css *.js \
          -ad.doubleclick.net/* \
          -www.google-analytics.com/* \
          -F "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
          %u || echo "httrack镜像完成"
        
    - name: Archive downloaded documentation
      uses: actions/upload-artifact@v4
      with:
        name: pyside6-offline-docs
        path: |
          pyside6-docs/
          pyside6-wget-docs/
          pyside6-httrack-docs/
        retention-days: 90
        
    - name: Create documentation summary
      run: |
        echo "### PySide6 离线文档下载摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载日期:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**PySide6 版本:** ${{ env.PYSIDE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**源网址:** ${{ env.DOCS_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**下载方法:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python脚本下载（选择性模块）" >> $GITHUB_STEP_SUMMARY
        echo "- wget完整镜像" >> $GITHUB_STEP_SUMMARY
        echo "- httrack专业镜像" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**文档结构:**" >> $GITHUB_STEP_SUMMARY
        echo "- 按模块组织的HTML文档" >> $GITHUB_STEP_SUMMARY
        echo "- 完整的导航和链接" >> $GITHUB_STEP_SUMMARY
        echo "- 可在任何浏览器中离线查看" >> $GITHUB_STEP_SUMMARY
        
        # 统计下载的文件数量
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**文件统计:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python脚本: $(find pyside6-docs -name '*.html' | wc -l) 个HTML文件" >> $GITHUB_STEP_SUMMARY
        echo "- wget镜像: $(find pyside6-wget-docs -name '*.html' | wc -l) 个HTML文件" >> $GITHUB_STEP_SUMMARY
        echo "- httrack镜像: $(find pyside6-httrack-docs -name '*.html' | wc -l) 个HTML文件" >> $GITHUB_STEP_SUMMARY
