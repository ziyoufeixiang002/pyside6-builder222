name: Build PySide6 6.10 Full Documentation (Base + API)

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

permissions:
  contents: read
  actions: write  # for cache

jobs:
  build-docs:
    runs-on: ubuntu-latest
    env:
      QT_VERSION: "6.10.0"
      QT_SRC_ARCHIVE: "qt-everywhere-src-${{ env.QT_VERSION }}.tar.xz"
      # å®˜æ–¹æºï¼ˆä¸»ï¼‰
      QT_SRC_URL_OFFICIAL: "https://download.qt.io/official_releases/qt/${{ env.QT_VERSION%.* }}/${{ env.QT_VERSION }}/single/${{ env.QT_SRC_ARCHIVE }}"
      # é•œåƒæºï¼ˆfallbackï¼‰
      QT_SRC_URL_TUNA: "https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/${{ env.QT_VERSION%.* }}/${{ env.QT_VERSION }}/single/${{ env.QT_SRC_ARCHIVE }}"
      QT_SRC_URL_USTC: "https://mirrors.ustc.edu.cn/qtproject/archive/qt/${{ env.QT_VERSION%.* }}/${{ env.QT_VERSION }}/single/${{ env.QT_SRC_ARCHIVE }}"
      # ç§æœ‰ Release æºï¼ˆéœ€æå‰ä¸Šä¼ åˆ°æœ¬ repo çš„ Releaseï¼Œå¦‚ v6.10.0-assetsï¼‰
      QT_SRC_RELEASE_TAG: "v6.10.0-assets"
      PYSIDE_REPO: "https://github.com/pyside/pyside-setup.git"
      PYSIDE_TAG: "v6.10.0"
      PYTHON_VERSION: "3.11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libxml2-dev libxslt1-dev \
            libgl1-mesa-dev libegl1-mesa-dev \
            graphviz libgraphviz-dev \
            wget tar xz-utils

      - name: Cache Qt source
        id: cache-qt-src
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_SRC_ARCHIVE }}
          key: qt-src-${{ env.QT_VERSION }}-v2  # â† v2: avoid stale cache

      - name: Download Qt source (try: cache â†’ official â†’ mirrors â†’ private release)
        if: steps.cache-qt-src.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "Qt source not cached. Attempting downloads..."

          # Try 1: official
          if wget -q --timeout=30 --tries=2 "${{ env.QT_SRC_URL_OFFICIAL }}" -O "${{ env.QT_SRC_ARCHIVE }}.part"; then
            mv "${{ env.QT_SRC_ARCHIVE }}.part" "${{ env.QT_SRC_ARCHIVE }}"
            echo "âœ… Downloaded from official source"
            exit 0
          else
            echo "âš ï¸ Official source failed. Trying mirrors..."
          fi

          # Try 2: TUNA
          if wget -q --timeout=30 --tries=2 "${{ env.QT_SRC_URL_TUNA }}" -O "${{ env.QT_SRC_ARCHIVE }}.part"; then
            mv "${{ env.QT_SRC_ARCHIVE }}.part" "${{ env.QT_SRC_ARCHIVE }}"
            echo "âœ… Downloaded from TUNA mirror"
            exit 0
          fi

          # Try 3: USTC
          if wget -q --timeout=30 --tries=2 "${{ env.QT_SRC_URL_USTC }}" -O "${{ env.QT_SRC_ARCHIVE }}.part"; then
            mv "${{ env.QT_SRC_ARCHIVE }}.part" "${{ env.QT_SRC_ARCHIVE }}"
            echo "âœ… Downloaded from USTC mirror"
            exit 0
          fi

          # Try 4: Private Release Asset (requires gh CLI & token)
          echo "âš ï¸ All mirrors failed. Trying private Release asset..."
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          if gh release download ${{ env.QT_SRC_RELEASE_TAG }} \
               --repo "$GITHUB_REPOSITORY" \
               -p "${{ env.QT_SRC_ARCHIVE }}" 2>/dev/null; then
            echo "âœ… Downloaded from private Release: ${{ env.QT_SRC_RELEASE_TAG }}"
            exit 0
          fi

          echo "âŒ Failed to download Qt source from all sources."
          ls -lh
          exit 1

      - name: Verify Qt archive integrity (optional but recommended)
        run: |
          # è‹¥ä½ æœ‰ SHA256SUMS æ–‡ä»¶ï¼Œå¯æå‰ä¸Šä¼ ä¸º artifact æˆ– hardcode
          # ç¤ºä¾‹ï¼šå·²çŸ¥ qt-everywhere-src-6.10.0.tar.xz çš„ SHA256
          EXPECTED_SHA256="a0e3e7b3e6b3f3e2a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5"  # â† âœï¸ æ›¿æ¢ä¸ºçœŸå®å€¼ï¼
          ACTUAL_SHA256=$(sha256sum "${{ env.QT_SRC_ARCHIVE }}" | cut -d' ' -f1)
          if [ "$ACTUAL_SHA256" != "$EXPECTED_SHA256" ]; then
            echo "âŒ SHA256 mismatch!"
            echo "Expected: $EXPECTED_SHA256"
            echo "Actual:   $ACTUAL_SHA256"
            exit 1
          else
            echo "âœ… SHA256 verified"
          fi

      - name: Extract Qt source
        run: |
          echo "Extracting Qt source..."
          mkdir -p qt-src
          time tar -xf "${{ env.QT_SRC_ARCHIVE }}" -C qt-src --strip-components=1
          echo "âœ… Extraction done."

      - name: Clone PySide6 setup repo at tag
        run: |
          git clone --depth 1 --branch ${{ env.PYSIDE_TAG }} ${{ env.PYSIDE_REPO }} pyside-setup

      - name: Install Python doc build requirements
        run: |
          cd pyside-setup
          pip install -r requirements-doc.txt

      - name: Set up virtual environment
        run: |
          python -m venv venv-docs
          source venv-docs/bin/activate
          pip install -U pip
          pip install -r pyside-setup/requirements-doc.txt

      - name: Ensure qdoc is available (install system Qt dev tools as fallback)
        run: |
          # å°è¯• locate qdoc6/qdoc
          if command -v qdoc6 >/dev/null 2>&1; then
            echo "âœ… qdoc6 found in PATH"
          elif command -v qdoc >/dev/null 2>&1; then
            echo "âœ… qdoc found in PATH"
          else
            echo "âš ï¸ qdoc not found; installing qt6-base-dev-tools..."
            sudo apt-get install -y qt6-base-dev-tools
            if ! command -v qdoc6 >/dev/null 2>&1; then
              echo "âŒ qdoc6 still missing after install"
              exit 1
            fi
          fi

      - name: Build PySide6 + Documentation
        run: |
          source venv-docs/bin/activate
          cd pyside-setup

          python setup.py build \
            --build-type=all \
            --module-subset=Core,Gui,Widgets \
            --qt-src-dir="${{ github.workspace }}/qt-src" \
            --build-docs \
            --doc-build-online \
            --skip-make-install \
            --skip-packaging \
            --verbose-build

      - name: Build API documentation via ninja
        run: |
          source venv-docs/bin/activate
          BUILD_DIR=$(find . -name "build" -type d -not -path "*/\.*" | grep -E "build.*${{ env.PYTHON_VERSION }}" | head -n1 || echo "./build")
          echo "Using build dir: $BUILD_DIR"
          cd "$BUILD_DIR/pyside6" || { echo "pyside6 build dir not found"; exit 1; }
          ninja apidoc -j $(nproc)

      - name: Collect artifacts
        run: |
          source venv-docs/bin/activate
          mkdir -p artifacts/{html,qch}

          HTML_DIR=$(find . -path "*/pyside6/doc/html" -type d | head -n1)
          SHIBOKEN_HTML_DIR=$(find . -path "*/shiboken6/doc/html" -type d | head -n1)
          QCH_FILES=$(find . -name "*.qch" -type f)

          [ -d "$HTML_DIR" ] && cp -r "$HTML_DIR"/* artifacts/html/ 2>/dev/null || echo "âš ï¸ PySide6 HTML not found"
          [ -d "$SHIBOKEN_HTML_DIR" ] && cp -r "$SHIBOKEN_HTML_DIR"/* artifacts/html/shiboken6/ 2>/dev/null || echo "âš ï¸ Shiboken HTML not found"
          [ -n "$QCH_FILES" ] && cp $QCH_FILES artifacts/qch/ 2>/dev/null || echo "âš ï¸ No QCH files found"

          cat > artifacts/index.html <<EOF
<!DOCTYPE html>
<html><head><title>PySide6 6.10 Docs</title></head><body>
<h1>PySide6 6.10 Documentation</h1>
<ul>
  <li><a href="html/pyside6/index.html">ğŸ“– HTML (PySide6)</a></li>
  <li><a href="html/shiboken6/index.html">ğŸ“– HTML (Shiboken)</a></li>
  <li><a href="qch/">ğŸ“¦ QCH Files</a> (use with Qt Assistant)</li>
</ul>
<p><small>Generated on: $(date -u)</small></p>
</body></html>
EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pyside6-docs-full
          path: artifacts/
          retention-days: 30

      - name: Optional: Deploy to GitHub Pages
        if: ${{ github.ref == 'refs/heads/main' && false }}  # â† set to `true` to enable
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: artifacts
          publish_branch: gh-pages
          force_orphan: true
