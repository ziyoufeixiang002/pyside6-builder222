name: Build PySide6 Documentation (Base + API)

on:
  push:
    branches: [ main ] # 或者您希望触发构建的分支
  pull_request:
    branches: [ main ] # 或者您希望触发构建的分支
  workflow_dispatch: # 允许手动触发

jobs:
  build-docs:
    runs-on: ubuntu-latest # 推荐使用 Ubuntu，因为 macOS 和 Windows 可能有更多依赖问题
    timeout-minutes: 120 # 设置较长的超时时间，因为构建很耗时

    steps:
    - name: Checkout PySide6 Setup Repository
      uses: actions/checkout@v4
      with:
        repository: pyside/pyside-setup
        path: pyside-setup

    # --- 安装系统依赖 ---
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        # 安装构建 PySide6 和文档所需的基本依赖
        sudo apt-get install -y build-essential cmake git libclang-dev libxml2-dev libxslt1-dev python3-dev graphviz

    # --- 设置 Python 环境 ---
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # 使用受支持的 Python 版本，根据需要调整

    # --- 安装 Python 依赖 ---
    - name: Install Python Documentation Requirements
      working-directory: ./pyside-setup
      run: |
        python -m pip install --upgrade pip
        # 安装文档构建所需的 Python 包
        if [ -f requirements-doc.txt ]; then pip install -r requirements-doc.txt; else echo "requirements-doc.txt not found in pyside-setup root, attempting to proceed."; fi

    # --- 获取 Qt 源码 (使用镜像仓库) ---
    - name: Get Qt Source Code (Mirror)
      run: |
        git clone --filter=blob:none --sparse https://github.com/qt/qt5.git qt5_src
        cd qt5_src
        # 检出特定的 Qt 6.x 版本标签，例如 6.8.0
        # 注意：请根据 pyside-setup 版本选择兼容的 Qt 版本
        git fetch --all --tags
        # 列出可用的 6.x 标签（可选，用于调试）
        git tag -l | grep -E "^v?6\.[0-9]+\.[0-9]+$" | sort -V | tail -5 || echo "No 6.x tags found or command failed"
        # 请根据需要调整版本号
        QT_TAG="v6.8.0" # 示例版本，务必根据实际情况修改
        git checkout tags/$QT_TAG -b qt-$QT_TAG
        # 获取必要的子模块（根据需要可能需要调整）
        git submodule update --init --depth 1 qtbase
        # 如果需要更多模块，可以在这里添加 submodule update 命令
        # git submodule update --init --depth 1 <module_name>

    # --- 构建 Shiboken 和 PySide6 ---
    - name: Build Shiboken and PySide6
      working-directory: ./pyside-setup
      run: |
        python setup.py build --build-type=all --parallel 2 # 使用 2 个核心并行构建以节省时间，根据 runner 能力调整
        # 安装到临时目录，以便文档构建脚本能找到它们
        python setup.py install --target /tmp/pyside6_install --no-deps # --no-deps 避免重复安装 Python 依赖

    # --- 构建完整文档 (Base + API) ---
    - name: Build Full Documentation (Base + API)
      working-directory: ./pyside-setup
      run: |
        # 设置 PYTHONPATH 以便找到刚构建安装的模块
        export PYTHONPATH="/tmp/pyside6_install:$PYTHONPATH"
        # 设置 PATH 以便找到 dot (graphviz)
        export PATH="/usr/bin:$PATH"
        # 运行构建命令，指定 Qt 源码路径
        # 注意：这里的 --qt-src-dir 指向的是克隆的 qt5_src 目录
        python setup.py build --build-type=all --parallel 2 --build-docs # 确保启用文档构建
        # 文档构建可能在 setup.py build 过程中完成，或者需要单独的步骤
        # 尝试运行 ninja apidoc (如果 setup.py build 没有完全完成文档构建)
        # 查找构建目录，通常在 build/<python_env_name>/build/pyside6
        # 注意：这里的路径可能需要根据实际 setup.py 输出调整
        # 假设构建目录是 build/$(python -c 'import sys; print("".join(sys.version.split()[:2]))')/build
        # 更可靠的查找方式
        BUILD_DIR=$(find /home/runner/work/pyside6-docs-builder/pyside6-docs-builder/pyside-setup/build -maxdepth 2 -type d -name "*pyside6" | head -n 1)
        SHIBOKEN_BUILD_DIR=$(find /home/runner/work/pyside6-docs-builder/pyside6-docs-builder/pyside-setup/build -maxdepth 2 -type d -name "*shiboken6" | head -n 1)
        echo "Found PySide6 build dir: $BUILD_DIR"
        echo "Found Shiboken6 build dir: $SHIBOKEN_BUILD_DIR"
        if [ -d "$BUILD_DIR" ]; then
            cd "$BUILD_DIR"
            if [ -f "build.ninja" ]; then
                ninja apidoc -j 2 # 使用 2 个核心并行构建文档
            else
                echo "build.ninja not found in $BUILD_DIR, assuming setup.py handled it or failed."
                # 如果 ninja 不可用，可能需要查找其他构建系统输出
                # 或者 setup.py build --build-docs 已经尝试构建了
                ls -la # 列出目录内容以便调试
            fi
        else
            echo "PySide6 build directory not found!"
            ls -la /home/runner/work/pyside6-docs-builder/pyside6-docs-builder/pyside-setup/build # 列出构建根目录以便调试
            exit 1
        fi
        if [ -d "$SHIBOKEN_BUILD_DIR" ]; then
            cd "$SHIBOKEN_BUILD_DIR"
            if [ -f "build.ninja" ]; then
                 # Shiboken 也可能有文档构建步骤，如果需要
                 # ninja apidoc # 通常 PySide6 的 ninja apidoc 会处理相关部分
                 echo "Shiboken build dir: $SHIBOKEN_BUILD_DIR"
            fi
        fi


    # --- 上传文档工件 ---
    - name: Upload Documentation Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PySide6-Docs-Base-API
        path: |
          pyside-setup/build/*/build/pyside6/doc/html
          pyside-setup/build/*/build/shiboken6/doc/html
          pyside-setup/build/*/build/pyside6/PySide.qch
          pyside-setup/build/*/build/shiboken6/Shiboken.qch
        if-no-files-found: ignore # 如果未找到文件，不要失败
        retention-days: 30
