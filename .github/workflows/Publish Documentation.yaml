name: Build Kotlin Stdlib Documentation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

env:
  KOTLIN_VERSION: '2.2.21'

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Kotlin repository
      uses: actions/checkout@v4
      with:
        repository: JetBrains/kotlin
        ref: 'v${{ env.KOTLIN_VERSION }}'  # 使用特定版本标签
        path: kotlin-repo
        fetch-depth: 1

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build documentation for all platforms
      working-directory: ./kotlin-repo
      run: |
        # 检查可用的 Gradle 任务
        ./gradlew tasks --all | grep dokka || true
        
        # 尝试构建主要模块的文档
        echo "Building Kotlin standard library documentation..."
        
        # 先尝试构建整个项目的文档
        ./gradlew dokkaHtmlMultiModule --no-daemon --stacktrace || \
        ./gradlew dokkaHtml --no-daemon --stacktrace || \
        echo "Dokka build failed, trying alternative approach"

    - name: Find and copy generated documentation
      working-directory: ./kotlin-repo
      run: |
        # 查找生成的文档
        find . -name "dokka" -type d | head -10
        find . -path "*/build/dokka/*" -name "index.html" | head -5 || echo "No index.html found"
        
        # 复制文档到工作目录
        mkdir -p ../generated-docs
        find . -path "*/build/dokka/*" -type f -name "*.html" | head -100 | xargs -I {} cp --parents {} ../generated-docs/ || echo "No HTML files found"

    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-stdlib-docs
        path: generated-docs
        retention-days: 30

  simple-docs:
    name: Simple Documentation Build
    runs-on: ubuntu-latest
    if: always()  # 即使上面的任务失败也运行
    
    steps:
    - name: Checkout Kotlin
      uses: actions/checkout@v4
      with:
        repository: JetBrains/kotlin
        ref: 'v${{ env.KOTLIN_VERSION }}'
        path: kotlin-src

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build specific stdlib modules
      working-directory: ./kotlin-src
      run: |
        # 尝试构建核心标准库模块
        echo "Available build files:"
        find . -name "build.gradle.kts" | head -5 || true
        find . -name "build.gradle" | head -5 || true
        
        echo "Trying to build specific modules..."
        # 尝试构建常见模块
        for module in "libraries/tools/kotlin-stdlib" "libraries/stdlib" "core"; do
          if [ -d "$module" ]; then
            echo "Building $module"
            ./gradlew :$module:dokkaHtml --no-daemon --stacktrace || continue
          fi
        done

    - name: Collect any generated docs
      working-directory: ./kotlin-src
      run: |
        mkdir -p ../collected-docs
        # 查找任何生成的文档
        find . -name "dokka" -type d -exec cp -r {} ../collected-docs/ \; 2>/dev/null || true
        find . -path "*/build/docs/*" -type f -name "*.html" | head -20 | xargs -I {} cp --parents {} ../collected-docs/ 2>/dev/null || true

    - name: Upload collected documentation
      uses: actions/upload-artifact@v4
      with:
        name: collected-kotlin-docs
        path: collected-docs
        retention-days: 30
