# å·¥ä½œæµåç§°ï¼šé•œåƒ Kotlin å®˜æ–¹ç½‘ç«™ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
name: Mirror Kotlin Website

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    # å¯é€‰çš„è¾“å…¥å‚æ•°
    inputs:
      exclude_patterns:
        description: 'é¢å¤–æ’é™¤çš„æ–‡ä»¶æ¨¡å¼'
        required: false
        default: '*.tmp,*.bak'
        type: string

  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  schedule:
    - cron: '0 3 * * 0'

  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]

# å·¥ä½œæµä»»åŠ¡å®šä¹‰
jobs:
  # é•œåƒç½‘ç«™ä»»åŠ¡
  mirror-website:
    name: Mirror Kotlinlang.org
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # æ­¥éª¤2ï¼šå®‰è£…å¿…è¦å·¥å…·
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        echo "å·¥å…·å®‰è£…å®Œæˆ"
        
    # æ­¥éª¤3ï¼šåˆ›å»ºé•œåƒç›®å½•
    - name: Create mirror directory
      run: |
        mkdir -p kotlin-mirror-$(date +%Y%m%d-%H%M%S)
        echo "MIRROR_DIR=kotlin-mirror-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "é•œåƒç›®å½•åˆ›å»º: ${{ env.MIRROR_DIR }}"
        
    # æ­¥éª¤4ï¼šä½¿ç”¨ wget é•œåƒç½‘ç«™ï¼ˆä¼˜åŒ–é…ç½®ï¼‰
    - name: Mirror website with wget
      run: |
        wget \
          --mirror \
          --page-requisites \
          --html-extension \
          --convert-links \
          --adjust-extension \
          --no-parent \
          --level=10 \
          --no-clobber \
          --timeout=30 \
          --tries=3 \
          --no-dns-cache \
          --delete-after \
          --reject-regex='.*\.(mp4|avi|mov|mkv|wmv|flv|webm|mp3|wav|flac|aac|ogg|wma|jpg|jpeg|png|gif|bmp|tiff|webp|svg|ico|raw|cr2|nef|arw)' \
          --regex-type=posix \
          --no-check-certificate \
          --restrict-file-names=windows \
          -e robots=off \
          -P ${{ env.MIRROR_DIR }} \
          https://kotlinlang.org/
          
        echo "ç½‘ç«™é•œåƒå®Œæˆ"
        
    # æ­¥éª¤5ï¼šæ˜¾ç¤ºé•œåƒç»Ÿè®¡ä¿¡æ¯
    - name: Display mirror statistics
      run: |
        echo "=== é•œåƒç»Ÿè®¡ä¿¡æ¯ ==="
        echo "é•œåƒç›®å½•: ${{ env.MIRROR_DIR }}"
        echo "æ€»æ–‡ä»¶æ•°: $(find ${{ env.MIRROR_DIR }} -type f | wc -l)"
        echo "æ€»ç›®å½•æ•°: $(find ${{ env.MIRROR_DIR }} -type d | wc -l)"
        echo "é•œåƒå¤§å°: $(du -sh ${{ env.MIRROR_DIR }} | cut -f1)"
        
        # æ˜¾ç¤ºæ–‡ä»¶ç±»å‹åˆ†å¸ƒ
        echo "=== æ–‡ä»¶ç±»å‹åˆ†å¸ƒ ==="
        find ${{ env.MIRROR_DIR }} -type f -name "*.html" | wc -l | xargs echo "HTML æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.css" | wc -l | xargs echo "CSS æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.js" | wc -l | xargs echo "JavaScript æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.pdf" | wc -l | xargs echo "PDF æ–‡ä»¶æ•°:"
        find ${{ env.MIRROR_DIR }} -type f -name "*.txt" | wc -l | xargs echo "æ–‡æœ¬æ–‡ä»¶æ•°:"
        
        echo "å®Œæˆæ—¶é—´: $(date)"
        
    # æ­¥éª¤6ï¼šæ¸…ç†ç©ºç›®å½•å’Œä¸´æ—¶æ–‡ä»¶
    - name: Clean up empty directories
      run: |
        # åˆ é™¤ç©ºç›®å½•
        find ${{ env.MIRROR_DIR }} -type d -empty -delete
        echo "ç©ºç›®å½•æ¸…ç†å®Œæˆ"
        
    # æ­¥éª¤7ï¼šä¸Šä¼ é•œåƒæ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
    - name: Upload mirror as artifact
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-mirror-$(date +%Y%m%d-%H%M%S)
        path: ${{ env.MIRROR_DIR }}
        retention-days: 30
        compression-level: 9

    # æ­¥éª¤8ï¼šæ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: Completion message
      run: |
        echo "âœ… Kotlin ç½‘ç«™é•œåƒä»»åŠ¡å®Œæˆï¼"
        echo "ğŸ“ é•œåƒä¿å­˜åœ¨: ${{ env.MIRROR_DIR }}"
        echo "ğŸ“¦ äº§ç‰©å·²ä¸Šä¼ ï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½"
